<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.jpg?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="nginx,"><meta name="description" content="¶一、简介Nginx 是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web 和反向代理服务器，也是一个 IMAP&#x2F;POP3&#x2F;SMTP 代理服务器。官方开源版官网：https:&#x2F;&#x2F;nginx.org文档：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs官方商业版官网：https:&#x2F;&#x2F;www.nginx.com中文官网：https:&#x2F;&#x2F;www.nginx-cn.netNGINX"><meta property="og:type" content="article"><meta property="og:title" content="nginx学习笔记"><meta property="og:url" content="https://www.qcmoke.cn/devops/nginx.html"><meta property="og:site_name" content="Qcmoke&#39;s Blog"><meta property="og:description" content="¶一、简介Nginx 是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web 和反向代理服务器，也是一个 IMAP&#x2F;POP3&#x2F;SMTP 代理服务器。官方开源版官网：https:&#x2F;&#x2F;nginx.org文档：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs官方商业版官网：https:&#x2F;&#x2F;www.nginx.com中文官网：https:&#x2F;&#x2F;www.nginx-cn.netNGINX"><meta property="og:image" content="https://www.qcmoke.cn/images/loading-post.gif"><meta property="og:image" content="https://www.qcmoke.cn/images/loading-post.gif"><meta property="article:published_time" content="2019-04-29T05:18:03.000Z"><meta property="article:modified_time" content="2024-07-20T20:04:07.754Z"><meta property="article:author" content="Qcmoke"><meta property="article:tag" content="nginx"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.qcmoke.cn/images/loading-post.gif"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"hide",offset:12,b2t:!1,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.qcmoke.cn/devops/nginx.html"><title>nginx学习笔记 | Qcmoke's Blog</title><meta name="generator" content="Hexo 4.2.1"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Qcmoke's Blog</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Peace & Love ! Learning to think independently !</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-热文"><a href="/top/" rel="section"><i class="menu-item-icon fa fa-fw fa-fire"></i><br>热文</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="menu-item-icon fa fa-fw fa-link"></i><br>友链</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.qcmoke.cn/devops/nginx.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Qcmoke"><meta itemprop="description" content=""><meta itemprop="image" content="/images/logo.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Qcmoke's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">nginx学习笔记</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-29T13:18:03+08:00">2019-04-29 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2024-07-21T04:04:07+08:00">2024-07-21 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/devops/nginx.html#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/devops/nginx.html" itemprop="commentCount"></span> </a></span><span id="/devops/nginx.html" class="leancloud_visitors" data-flag-title="nginx学习笔记"><span class="post-meta-divider">|</span> <span class="lv-inline-block" style="display:inline-block"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数&#58;</span> <span class="leancloud-visitors-count"></span></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">11.6k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">47</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一-简介"><a class="header-anchor" href="#一-简介">¶</a>一、简介</h2><p>Nginx 是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的 Web 和反向代理服务器，也是一个 IMAP/POP3/SMTP 代理服务器。</p><ul><li>官方开源版<ul><li>官网：<a href="https://nginx.org" target="_blank" rel="noopener">https://nginx.org</a></li><li>文档：<a href="https://nginx.org/en/docs" target="_blank" rel="noopener">https://nginx.org/en/docs</a></li></ul></li><li>官方商业版<ul><li>官网：<a href="https://www.nginx.com" target="_blank" rel="noopener">https://www.nginx.com</a></li><li>中文官网：<a href="https://www.nginx-cn.net" target="_blank" rel="noopener">https://www.nginx-cn.net</a></li><li>NGINX Plus 文档：<a href="https://docs.nginx.com/nginx" target="_blank" rel="noopener">https://docs.nginx.com/nginx</a></li></ul></li></ul><p>在高连接并发的情况下，Nginx 是 Apache 服务器不错的替代品。</p><h2 id="二-在线包管理器安装nginx"><a class="header-anchor" href="#二-在线包管理器安装nginx">¶</a>二、在线包管理器安装nginx</h2><h3 id="1-apt安装nginx"><a class="header-anchor" href="#1-apt安装nginx">¶</a>1. apt安装nginx</h3><h4 id="1-安装nginx"><a class="header-anchor" href="#1-安装nginx">¶</a>（1）安装nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install -y nginx</span><br><span class="line"><span class="comment">#查看Nginx的显式编译参数</span></span><br><span class="line">nginx -V</span><br></pre></td></tr></table></figure><h4 id="3-卸载nginx"><a class="header-anchor" href="#3-卸载nginx">¶</a>（3）卸载nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop nginx</span><br><span class="line">apt purge -y nginx nginx-common</span><br><span class="line"><span class="comment">#卸载系统中所有不再需要的依赖包</span></span><br><span class="line">apt autoremove -y</span><br><span class="line"><span class="comment">#删除已下载的软件包文件的缓存</span></span><br><span class="line">apt clean</span><br><span class="line"><span class="comment">#删除nginx配置文件（如需要）</span></span><br><span class="line">rm -rf /etc/nginx/</span><br></pre></td></tr></table></figure><blockquote><p>如果由于 Nginx 卸载不干净导致出现重装失败的问题，解决可参考：<a href="https://www.cnblogs.com/alter888/p/9478022.html" target="_blank" rel="noopener">https://www.cnblogs.com/alter888/p/9478022.html</a></p></blockquote><h3 id="2-yum安装nginx"><a class="header-anchor" href="#2-yum安装nginx">¶</a>2. yum安装nginx</h3><h4 id="1-设置nginx官方yum源-可选"><a class="header-anchor" href="#1-设置nginx官方yum源-可选">¶</a>（1）设置nginx官方yum源（可选）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><blockquote><p>设置 nginx 官方 yum 源以能够使用最新版本</p></blockquote><h4 id="2-安装nginx"><a class="header-anchor" href="#2-安装nginx">¶</a>（2）安装nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure><h4 id="3-查看nginx安装信息"><a class="header-anchor" href="#3-查看nginx安装信息">¶</a>（3）查看nginx安装信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看已经安装nginx包（如：nginx-1.16.0-1.el7.ngx.x86_64）</span></span><br><span class="line">rpm -q nginx</span><br><span class="line"><span class="comment">#查看nginx版本（如：nginx version: nginx/1.16.0）</span></span><br><span class="line">nginx -v</span><br><span class="line"><span class="comment">#查看yum安装nginx的目录</span></span><br><span class="line">rpm -ql nginx</span><br><span class="line"><span class="comment">#查看Nginx的显式编译参数</span></span><br><span class="line">nginx -V</span><br></pre></td></tr></table></figure><h4 id="4-卸载nginx"><a class="header-anchor" href="#4-卸载nginx">¶</a>（4）卸载nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop nginx</span><br><span class="line">yum remove -y nginx</span><br><span class="line"><span class="comment">#卸载系统中所有不再需要的依赖包</span></span><br><span class="line">yum autoremove -y</span><br><span class="line"><span class="comment">#删除nginx配置文件（如需要）</span></span><br><span class="line">rm -rf /etc/nginx/</span><br></pre></td></tr></table></figure><h3 id="3-在线包管理器安装nginx路径"><a class="header-anchor" href="#3-在线包管理器安装nginx路径">¶</a>3. 在线包管理器安装nginx路径</h3><blockquote><p>安装nginx的目录如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Nginx主配置文件</span><br><span class="line">&#x2F;etc&#x2F;nginx                         </span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d </span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br><span class="line">   </span><br><span class="line">Cgi、Fastcgi、Uwcgi配置文件</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;fastcgi_params</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;scgi_params</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;uwsgi_params</span><br><span class="line">   </span><br><span class="line">Nginx编码转换映射配置文件</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;win-utf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;koi-utf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;koi-win</span><br><span class="line">   </span><br><span class="line">http协议的Content-Type与扩展名配置文件</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;mime.types</span><br><span class="line"></span><br><span class="line">系统守护进程管理器配置文件</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service</span><br><span class="line"></span><br><span class="line">Nginx⽇志轮询,⽇志切割配置文件</span><br><span class="line">&#x2F;etc&#x2F;logrotate.d&#x2F;nginx</span><br><span class="line"></span><br><span class="line">Nginx终端管理命令</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;nginx-debug</span><br><span class="line">   </span><br><span class="line">Nginx模块⽬录</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;modules</span><br><span class="line">&#x2F;usr&#x2F;lib64&#x2F;nginx</span><br><span class="line">&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules</span><br><span class="line">   </span><br><span class="line">Nginx默认站点⽬录</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line"></span><br><span class="line">#Nginx的缓存⽬录</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx-1.12.2</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;nginx.8.gz</span><br><span class="line"></span><br><span class="line">Nginx的⽇志⽬录</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;nginx</span><br></pre></td></tr></table></figure><p>yum安装nginx的编译参数如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">程序安装⽬录和路径</span><br><span class="line">--prefix&#x3D;&#x2F;etc&#x2F;nginx</span><br><span class="line">--sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">--modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules</span><br><span class="line">--conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">--error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log</span><br><span class="line">--http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log</span><br><span class="line">--pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid</span><br><span class="line">--lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock</span><br><span class="line">   </span><br><span class="line">临时缓存⽂件</span><br><span class="line">--http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp</span><br><span class="line">--http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp</span><br><span class="line">--http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp</span><br><span class="line">--http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp</span><br><span class="line">--http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp</span><br><span class="line"></span><br><span class="line">设定Nginx进程启动⽤户和组(安全)</span><br><span class="line">--user&#x3D;nginx</span><br><span class="line">--group&#x3D;nginx</span><br><span class="line"></span><br><span class="line">设置额外的参数将被添加到CFLAGS变量</span><br><span class="line">--with-cc-opt</span><br><span class="line"></span><br><span class="line">设置附加的参数, 链接系统库</span><br><span class="line">--with-ld-opt</span><br></pre></td></tr></table></figure></blockquote><h2 id="二-源码编译安装nginx"><a class="header-anchor" href="#二-源码编译安装nginx">¶</a>二、源码编译安装nginx</h2><p>官方下载地址：<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p><p>版本号是双数的是稳定版，而单数则是开发版。</p><p>以下以编译安装来讲述。为什么选择编译安装而不选择yum或者apt包管理器安装呢？因为yum或者apt安装的是已经编译好的二进制文件，而已经编译好就说明扩展模块已经固定，很难去添加或者修改自定义的扩展模块，这里选择编译安装就是为了解决这个问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum安装nginx编译依赖</span></span><br><span class="line">yum install -y gcc gcc-c++ zlib  gd-devel zlib-devel openssl   openssl-devel pcre-devel make </span><br><span class="line"></span><br><span class="line"><span class="comment">#apt安装nginx编译依赖</span></span><br><span class="line"><span class="comment"># apt install -y gcc make build-essential zlib1g-dev libpcre3-dev libssl-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载nginx源码包</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br><span class="line"><span class="comment">#解压nginx源码包</span></span><br><span class="line">tar zxvf nginx-1.18.0.tar.gz</span><br><span class="line"><span class="comment">#设置vim编辑nginx配置文件语法高亮（可选，如果不想用了直接删除~/.vim/目录即可）</span></span><br><span class="line">mkdir ~/.vim &amp;&amp; cp -r  nginx-1.18.0/contrib/vim/* ~/.vim/</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入解压好的nginx源码目录</span></span><br><span class="line"><span class="built_in">cd</span> nginx-1.18.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成nginx的编译配置文件MakeFile</span></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/opt/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_sub_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_stub_status_module</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据MakeFile编译nginx</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装nginx</span></span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#卸载nginx（如需要）</span></span><br><span class="line">rm -rf /opt/nginx</span><br><span class="line"><span class="comment">#如果MakeFile里有uninstall目标，也可以通过make uninstall进行卸载</span></span><br><span class="line"><span class="comment">#make uninstall</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清除编译生成文件（如需要，包括生成的MakeFile、二进制文件等）</span></span><br><span class="line">make clean</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除解压nginx源码目录和nginx安装包（如需要）</span></span><br><span class="line"><span class="built_in">cd</span> .. &amp;&amp; rm -rf nginx-1.18.0 &amp;&amp; rm -f nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure><blockquote><p>💁‍♂ nginx 安装目录结构说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;/opt/nginx</span><br><span class="line">&gt;├── conf   <span class="comment">#存放配置文件</span></span><br><span class="line">&gt;│   ├── fastcgi.conf</span><br><span class="line">&gt;│   ├── fastcgi.conf.default</span><br><span class="line">&gt;│   ├── fastcgi_params</span><br><span class="line">&gt;│   ├── fastcgi_params.default</span><br><span class="line">&gt;│   ├── koi-utf</span><br><span class="line">&gt;│   ├── koi-win</span><br><span class="line">&gt;│   ├── mime.types</span><br><span class="line">&gt;│   ├── mime.types.default</span><br><span class="line">&gt;│   ├── nginx.conf</span><br><span class="line">&gt;│   ├── nginx.conf.default</span><br><span class="line">&gt;│   ├── scgi_params</span><br><span class="line">&gt;│   ├── scgi_params.default</span><br><span class="line">&gt;│   ├── uwsgi_params</span><br><span class="line">&gt;│   ├── uwsgi_params.default</span><br><span class="line">&gt;│   └── win-utf</span><br><span class="line">&gt;├── html    <span class="comment">#web基础根目录</span></span><br><span class="line">&gt;│   ├── 50xhtml</span><br><span class="line">&gt;│   └── index.html</span><br><span class="line">&gt;├── logs    <span class="comment">#日志文件目录</span></span><br><span class="line">&gt;└── sbin    <span class="comment">#执行脚本目录</span></span><br><span class="line">   └── nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>💁‍♂ 常用编译参数说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt;--prefix=绝对路径	<span class="comment">#定义nginx安装目录。默认为/usr/local/nginx目录。注意：这个目标的设置会影响其他参数中的相对路径目录。（例如：--sbin-path==sbin/nginx,那么实际上可执行文件nginx的安装存放路径为/opt/nginx/sbin/nginx。）</span></span><br><span class="line">&gt;--sbin-path=path	<span class="comment">#设置nginx可执行文件的安装存放路径。默认为&lt;prefix&gt;/sbin/nginx。</span></span><br><span class="line">&gt;--conf-path=path	<span class="comment">#设置nginx.conf配置文件的安装存放路径。默认为&lt;prefix&gt;/conf目录。</span></span><br><span class="line">&gt;--pid-path=path 	<span class="comment">#设置将存储主进程的进程ID的nginx.pid文件的路径。默认&lt;prefix&gt;/logs/nginx.pid</span></span><br><span class="line">&gt;--error-log-path=path	<span class="comment">#设置error警告和诊断日志路径。默认&lt;prefix&gt;/logs/error.log</span></span><br><span class="line">&gt;--http-log-path=path	<span class="comment">#设置每个HTTP请求完成的记录日志路径。默认&lt;prefix&gt;/logs/access.log</span></span><br><span class="line">&gt;--user=用户名 	<span class="comment">#指定Nginx worker进程运行时所属的用户。默认为：nobody。</span></span><br><span class="line">&gt;--group=用户组 <span class="comment">#指定Nginx worker进程运行时所属的用户组。默认为：nobody。</span></span><br><span class="line">&gt;--with-pcre	<span class="comment">#允许用户使用正则表达式进行模式匹配和文本处理。（默认启用）</span></span><br><span class="line">&gt;--with-threads	<span class="comment">#启用 Nginx 的线程池功能。（默认启用）</span></span><br><span class="line">&gt;--with-poll_module <span class="comment">#启用poll多路复用器模块，用于处理网络事件的多路复用。（默认启用，如果不显式指定这--with-select_module或--with-poll_module中的任何一个，Nginx 默认会使用 --with-poll_module）</span></span><br><span class="line">&gt;--with-select_module	<span class="comment">#启用select多路复用器模块。（默认未启用）</span></span><br><span class="line">&gt;--with-file-aio <span class="comment">#启用文件异步io支持。（默认未启用）</span></span><br><span class="line">&gt;--with-ipv6	<span class="comment">#启用对IPv6的支持。（默认启用）</span></span><br><span class="line">&gt;--with-http_upstream_module <span class="comment">#启用反向代理和负载均衡的功能，由ngx_http_upstream_module模块支持（默认启用）</span></span><br><span class="line"></span><br><span class="line">&gt;--with-http_ssl_module	<span class="comment">#启用构建将HTTPS协议支持添加到HTTP服务器的模块的功能。需要OpenSSL库来构建和运行此模块。（默认未启用）</span></span><br><span class="line">&gt;--with-http_gzip_static_module <span class="comment">#用于预压缩静态文件，从而提高网站的性能。（默认未启用）</span></span><br><span class="line">&gt;--with-http_gunzip_module <span class="comment">#用于在 Nginx 中解压缩经过压缩的 HTTP 响应，以便客户端可以正常接收响应。（默认未启用）</span></span><br><span class="line">&gt;--with-http_sub_module <span class="comment">#用于在响应内容中执行字符串替换操作，常用于修改 HTML、CSS、JavaScript 等响应内容。（默认未启用）</span></span><br><span class="line">&gt;--with-http_realip_module <span class="comment">#用于替换客户端 IP 地址，以解决反向代理中的 IP 地址伪装问题。（默认未启用）</span></span><br><span class="line">&gt;--with-http_image_filter_module <span class="comment">#提供了在 HTTP 请求中处理图像的功能，例如缩放、裁剪、旋转、反转等功能。（默认未启用）</span></span><br><span class="line">&gt;--with-http_mp4_module <span class="comment">#提供了处理 MP4 文件的功能，包括切割、拼接、编码等。（默认未启用）</span></span><br><span class="line">&gt;--with-mail	<span class="comment">#安装邮件服务器反向代理模块，使nginx可以反向代理IMAP、POP3、SMTP等协议。（默认未启用）</span></span><br><span class="line">&gt;--with-mail_ssl_module	<span class="comment">#使IMAP、POP3、SMTP等协议支持SSL/TLS协议加密传输支持。（默认未启用）</span></span><br><span class="line">&gt;--with-http_v2_module <span class="comment">#是用于启用 HTTP/2 模块的选项。（默认未启用）</span></span><br><span class="line">&gt;--with-http_stub_status_module <span class="comment">#提供了一个简单的状态页面，用于监控 Nginx 服务器的运行状态。（默认未启用）</span></span><br></pre></td></tr></table></figure><p>如果想强制禁用某个模块，只需要将<code>--with</code>改成<code>--without</code>。比如禁用select多路复用器模块，则参数为：<code>--without-select_module</code></p></blockquote><h2 id="三-nginx常用命令"><a class="header-anchor" href="#三-nginx常用命令">¶</a>三、nginx常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止</span></span><br><span class="line">nginx -s stop <span class="comment">#立即停止服务（查出nginx进程id后直接强制kill杀掉进程）</span></span><br><span class="line">nginx -s quit <span class="comment">#安全地停止服务（等待所有请求处理完成再停止服务）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新加载配置（重新加载配置而无需停止或重启服务）</span></span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检测配置文件正确性</span></span><br><span class="line">nginx  -t</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看nginx的【显式】编译参数</span></span><br><span class="line">nginx -V</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看nginx是否在运行</span></span><br><span class="line">ps aux | grep nginx</span><br></pre></td></tr></table></figure><blockquote><p>关于<code>nginx -V</code>查看编译参数的说明：</p><p>注意执行<code>nginx -V</code>只是列出在编译时执行<code>./configure</code>的显式设置参数，而不代表真实编译进nginx的配置，比如有很多的编译参数是默认启用的，编译时也被编译进nginx了，但是通过<code>nginx -V</code>命令却不能看到对应的参数。如在执行<code>./configure</code>时即使没有显式地设置<code>--with-pcre</code>这个编译参数，但是编译好的nginx还是能够使用正则匹配功能。</p></blockquote><h2 id="五-nginx内置变量"><a class="header-anchor" href="#五-nginx内置变量">¶</a>五、nginx内置变量</h2><p>http核⼼模块的内置变量</p><blockquote><p>http请求变量<br>Nginx内置变量<br>⾃定义变量</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$uri</span>: 当前请求的uri，不带参数</span><br><span class="line"><span class="variable">$request_uri</span>: 客户端请求的uri，带完整参数</span><br><span class="line"><span class="variable">$host</span>: 客户端请求头中Host字段除去端口号的部分。可用于获取请求的域名信息，如果host⾸部为空则<span class="variable">$host</span>等价</span><br><span class="line"><span class="variable">$http_host</span>: 客户端请求头中Host的完整字段（如有客户端请求头Host中有端口则<span class="variable">$http_host</span>包含端口）</span><br><span class="line"><span class="variable">$proxy_host</span>：指proxy_pass中设置的host值（对于端口，默认80不包含，其他端口包含）</span><br><span class="line"><span class="variable">$remote_addr</span>: 客户端IP（如果只经过一个代理服务器，则可以表示客户端的真实IP，但如果经过多个代理服务器，则只能表示最后代理服务器的IP）</span><br><span class="line"><span class="variable">$remote_port</span>: 客户端请求的端口（客户端通常会使用随机的动态端口来发起请求）</span><br><span class="line"><span class="variable">$remote_user</span>: 客户端发起请求时的 HTTP 认证用户名</span><br><span class="line"><span class="variable">$request_filename</span>: 客户端请求的文件路径</span><br><span class="line"><span class="variable">$request_method</span>: 求⽅法,	GET	POST	PUT</span><br><span class="line"><span class="variable">$server_addr</span>: 前服务器的 IP 地址</span><br><span class="line"><span class="variable">$server_name</span>: 服务器配置的域名。可用于获取当前服务器块（server block）的配置的域名信息（如果在配置中使用了多个 server_name 声明，<span class="variable">$server_name</span> 将会返回第一个匹配成功的域名。）</span><br><span class="line"><span class="variable">$server_port</span>: 服务器监听的端口</span><br><span class="line"><span class="variable">$server_protocol</span>: nginx服务器使用的协议版本,	如http/1.1	http/1.0</span><br><span class="line"><span class="variable">$scheme</span>：客户端请求的协议方案，如：http 或 https 等</span><br><span class="line"><span class="variable">$document_root</span>:	当前请求映射到的root配置</span><br><span class="line"><span class="variable">$hostname</span>: nginx所在的服务器的主机名</span><br></pre></td></tr></table></figure><h2 id="六-自定义nginx配置文件"><a class="header-anchor" href="#六-自定义nginx配置文件">¶</a>六、自定义nginx配置文件</h2><p>只需在 nginx 主配置文件 <code>nginx.conf</code> 的 <code>http</code> 节点中导入 <code>conf/conf.d</code> 目录（如果没有自行创建该目录）的所有配置文件，即可在 <code>conf/conf.d</code> 目录下自定义配置文件。如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> mime.types;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">    <span class="comment">#以上为其他无关配置...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">### 添加这行代码 ###</span></span><br><span class="line">    <span class="attribute">include</span> conf.d/<span class="regexp">*.conf</span>; <span class="comment">#nginx加载主配置文件的时候自动导入conf.d目录下的所有自定义配置文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#以下为其他无关配置...</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="七-配置http服务"><a class="header-anchor" href="#七-配置http服务">¶</a>七、配置http服务</h2><p>（1）创建nginx配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/nginx/conf/conf.d/http.conf</span><br></pre></td></tr></table></figure><p>内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 第一个虚拟主机配置(静态资源服务器)</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="comment">#server_name example.com;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /opt/nginx/html; <span class="comment">#配置web根目录</span></span><br><span class="line">        <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#图片资源</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ .*\.(jpg|png|gif)$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /opt/nginx/html;</span><br><span class="line">        <span class="attribute">gzip</span>	<span class="literal">on</span>;	<span class="comment">#传输压缩，压缩本身比较耗费服务端性能，但给带宽带来更好的传输。恰当的使用会增强资源的访问效率。</span></span><br><span class="line">        <span class="attribute">gzip_http_version</span>	<span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">gzip_comp_level</span>	<span class="number">2</span>;</span><br><span class="line">        <span class="attribute">gzip_types</span> gzip_types text/plain application/json application/x-javascript application/css application/xml application/xml+rss text/javascript application/x-httpd-php image/jpeg image/gif image/png;	<span class="comment">#压缩的文件类型，一般按需选择，但这里为了未来方便添加文件类型多选一些。具体配置参考文件/etc/nginx/mime.types</span></span><br><span class="line">        <span class="attribute">expires</span> <span class="number">1h</span>;	<span class="comment">#设置静态资源文件在客户端的缓存时间，除非客户清楚缓存或者关闭缓存或者强制访问才会再访问。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#文件下载</span></span><br><span class="line">    <span class="attribute">location</span> /download &#123;</span><br><span class="line">        <span class="attribute">root</span> /opt/nginx/html; <span class="comment">#访问 http://localhost:8080/download/test.txt 时会下载 /opt/nginx/html/test.txt 路径的文件</span></span><br><span class="line">        <span class="attribute">charset</span> utf-<span class="number">8</span>,gbk;	<span class="comment">#解决目录或者文件显示中文乱码的问题</span></span><br><span class="line">        <span class="attribute">autoindex</span> <span class="literal">on</span>;	<span class="comment">#自动显示资源路径的文件名称，以此来开启站点下载。默认为关闭。</span></span><br><span class="line">        <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;	<span class="comment">#显示的⽂文件时间为文件的服务器时间。默认为off，显示的文件时间为GMT时间</span></span><br><span class="line">        <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;	<span class="comment">#默认为on， 显示出文件的确切⼤大小，单位是bytes;修改为off，显示出文件的⼤大概大小，单位是kB或者MB或者GB。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二个虚拟主机配置</span></span><br><span class="line"><span class="comment"># server &#123;</span></span><br><span class="line"><span class="comment">#     listen	8081;</span></span><br><span class="line"><span class="comment">#     server_name	localhost;	#主机名，一般为一个或多个域名或者ip</span></span><br><span class="line"><span class="comment">#     location / &#123;</span></span><br><span class="line"><span class="comment">#         root	/opt/nginx/html;</span></span><br><span class="line"><span class="comment">#         index	index.html index.htm;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure><p>（2）配置防火墙和重载 nginx 配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#防火墙开放相关监听端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#重载配置</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><p>（3）测试</p><blockquote><p>设服务器 IP 地址为：<code>198.23.188.200</code>，则访问地址：<a href="http://198.23.188.200:8080" target="_blank" rel="noopener">http://198.23.188.200:8080</a></p></blockquote><h2 id="八-配置反向代理"><a class="header-anchor" href="#八-配置反向代理">¶</a>八、配置反向代理</h2><blockquote><p>反向代理：即将客户端对本机的访问请求代理转发到其他服务器。在反向代理中可以按需求配置将请求转发到一个或多个服务器，如果是多个服务器则可实现负载均衡的功能效果。</p></blockquote><h3 id="1-反向代理常用指令"><a class="header-anchor" href="#1-反向代理常用指令">¶</a>1. 反向代理常用指令</h3><blockquote><p>代理请求常用指令：</p><ul><li><p><code>proxy_pass</code>: 指定反向代理的目标服务器地址。例如：<code>proxy_pass http://backend_server;</code></p></li><li><p><code>proxy_set_header</code>: 设置传递给后端服务器的请求头信息（只有目标服务器需要解析这些请求头时才有必要配置，否则可以不配置）。常见的请求头设置配置如下：</p></li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> <span class="string">"Connection"</span> <span class="string">""</span>; <span class="comment">#删除Connection请求头</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>; <span class="comment">#设置请求头指定代理请求时的Host头，$host表示使用客户端的Host（不包含端口）作为代理请求的Host</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>; <span class="comment">#设置请求头指定客户端真实IP，$remote_addr表示客户端的IP（如果只经过一个代理服务器，则可以表示客户端的真实IP，但如果经过多个代理服务器，则只能表示最后代理服务器的IP）</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; <span class="comment">#设置请求头指定客户端的真实IP以及每次途经的代理IP（由逗号隔开,如："192.168.60.1, 192.168.60.101"，第一个IP即为客户端的真实IP。目标服务器使用X-Forwarded-For获取客户端真实IP比较可靠）</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>; <span class="comment">#设置请求头指定使用的协议（如：http或者https，$scheme表示客户端请求nginx时使用的协议）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##其他请求头设置</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> Range <span class="variable">$http_range</span>;</span><br></pre></td></tr></table></figure><ul><li><code>proxy_http_version</code>: 指定 Nginx 使用的 HTTP 协议版本（如：<code>1.0</code>（默认）、<code>1.1</code>）。例如：<code>proxy_http_version 1.1;</code></li><li><code>proxy_cache</code>: 设置反向代理缓存。可以通过 <code>proxy_cache</code> 指令来启用缓存并指定缓存名称。例如：<code>proxy_cache my_cache;</code></li><li><code>proxy_redirect</code>: 设置反向代理的重定向规则。可选值：<code>default</code>（默认值，会自动替换响应头中的域名部分，实现反向代理的重定向）、<code>off</code>（禁用重定向，不进行任何修改）、<code>redirect &lt;replacement&gt;</code>（指定自定义的重定向规则，可以使用正则表达式等方式来进行替换）。例如：<code>proxy_redirect default;</code></li><li><code>proxy_connect_timeout</code>: 设置与后端服务器建立连接的超时时间。例如：<code>proxy_connect_timeout 5s;</code></li><li><code>proxy_read_timeout</code>: 设置从后端服务器读取响应的超时时间。例如：<code>proxy_read_timeout 10s;</code></li><li><code>proxy_send_timeout</code>: 设置向后端服务器发送请求的超时时间。例如：<code>proxy_send_timeout 10s;</code></li><li><code>proxy_buffering</code>： 启用或禁用反向代理缓冲。可选：<code>on</code>（默认）、<code>off</code>，例如：<code>proxy_buffering on;</code></li><li><code>proxy_buffer_size &lt;size&gt;</code>：设置反向代理使用的缓冲区大小。默认 4KB。使用示例：<code>proxy_buffer_size 8k;</code></li><li><code>proxy_buffers &lt;number&gt; &lt;size&gt;</code>：设置反向代理缓冲区的数量和大小。默认每个连接分配两个缓冲区，每个缓冲区大小为 4KB。如：<code>proxy_buffers 4 16k;</code></li><li><code>proxy_busy_buffers_size &lt;size&gt;</code>：设置 Nginx 可以积累的响应数据大小。默认为 <code>proxy_buffers</code> 中每个缓冲区的大小。使用示例：<code>proxy_busy_buffers_size 32k;</code></li><li><code>proxy_ignore_headers</code>: 设置要忽略的响应头字段。例如：<code>proxy_ignore_headers X-Accel-Expires Expires Cache-Control;</code></li><li><code>proxy_intercept_errors</code>: 启用或禁用拦截来自后端服务器的错误响应。使用示例：<code>proxy_intercept_errors on;</code></li><li><code>proxy_max_temp_file_size &lt;size&gt;</code>：设置代理模块在处理响应时，允许创建的临时文件的最大大小。默认：1024MB。使用示例：<code>proxy_max_temp_file_size 512m;</code></li></ul><p>代理相应常用指令：</p><ul><li>1）<code>add_header</code>： 添加自定义响应头到服务器的响应中。例如跨域配置，如下：</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">"GET, POST, OPTIONS, PUT, DELETE"</span>;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">"Authorization, Content-Type, X-Requested-With"</span>;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Max-Age <span class="number">86400</span>;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">"GET, POST, OPTIONS, PUT, DELETE"</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">"Authorization, Content-Type, X-Requested-With"</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Max-Age <span class="number">86400</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Content-Length <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Content-Type <span class="string">"text/plain charset=UTF-8"</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-简单的反向代理配置"><a class="header-anchor" href="#2-简单的反向代理配置">¶</a>2. 简单的反向代理配置</h3><h4 id="1-反向代理相关配置"><a class="header-anchor" href="#1-反向代理相关配置">¶</a>1）反向代理相关配置</h4><p>nginx 配置相关内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上游服务器配置（后端服务器）</span></span><br><span class="line"><span class="attribute">upstream</span> ops_load &#123;</span><br><span class="line">    <span class="comment">#负载均衡配置</span></span><br><span class="line">        <span class="comment">#配置多个http服务器即可实现负载均衡，其中http服务器可为本机，也可以为其他服务器</span></span><br><span class="line">        <span class="comment">#默认负载均衡的调度模式为轮询方式</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="comment">#反向代理</span></span><br><span class="line">        <span class="comment">#proxy_pass http://localhost:8081; #如果只需要代理到一个服务器，则可以如此配置</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://ops_load; <span class="comment">#如果只需要代理到多个服务器，则可以配置upstream来设置多个服务器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-反向代理测试示例"><a class="header-anchor" href="#2-反向代理测试示例">¶</a>2）反向代理测试示例</h4><blockquote><p>测试示例需求：在本地的 nginx 中模拟反向代理到本地不同端口的上游服务器。</p></blockquote><p>（1）创建nginx配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/nginx/conf/conf.d/load_balance.conf</span><br></pre></td></tr></table></figure><p>内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上游服务器配置（后端服务器）</span></span><br><span class="line"><span class="attribute">upstream</span> ops_load &#123;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">8081</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8083</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://ops_load;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟3个上游服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line">    <span class="attribute">root</span> /opt/nginx/html/node1;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">    <span class="attribute">root</span> /opt/nginx/html/node2;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">root</span> /opt/nginx/html/node3;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（2）服务节点差异设置</p><p>为了更直观的测试负载均衡效果，可给不同的服务节点的访问页面做一些差异内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/nginx/html/&#123;node1,node2,node3&#125;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"node1"</span> &gt; /opt/nginx/html/node1/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"node2"</span> &gt; /opt/nginx/html/node2/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"node3"</span> &gt; /opt/nginx/html/node3/index.html</span><br></pre></td></tr></table></figure><p>（3）配置防火墙和重载 nginx 配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#防火墙开放相关监听端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#重载配置</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><p>（4）测试</p><blockquote><p>设服务器 IP 地址为：<code>198.23.188.200</code>，则访问地址：<a href="http://198.23.188.200:8080" target="_blank" rel="noopener">http://198.23.188.200:8080</a></p><p>提示：浏览器要设置“停用缓存”，否则可能一直观察到的都是一个内容。</p></blockquote><h3 id="3-高级的反向代理配置"><a class="header-anchor" href="#3-高级的反向代理配置">¶</a>3. 高级的反向代理配置</h3><h4 id="1-负载均衡调度模式配置"><a class="header-anchor" href="#1-负载均衡调度模式配置">¶</a>1）负载均衡调度模式配置</h4><p>在Nginx中，可以使用以下几种负载均衡调度模式：</p><blockquote><ol><li>轮询（Round Robin）：默认情况下，Nginx使用轮询模式进行负载均衡。它按照每个后端服务器的顺序依次分配请求，确保每个后端服务器平均分担负载。</li><li>加权轮询（Weighted Round Robin）：可以为每个后端服务器分配不同的权重，以调整它们接收请求的比例。较高权重的服务器将获得更多的请求。</li><li>IP哈希（IP Hash）：基于客户端IP地址对请求进行哈希运算，将相同IP的请求始终转发到同一个后端服务器。这对于需要保持会话或状态的应用程序非常有用。</li><li>最少连接（Least Connections）：将请求分配给当前连接数最少的后端服务器。这有助于平衡服务器的负载，将请求发送到连接较少的服务器，以确保更均匀的负载分布。</li><li>URL哈希（URL Hash）：基于请求的URL对后端服务器进行哈希运算，使相同URL的请求总是转发到同一个后端服务器。这对于需要缓存或特定处理逻辑的应用程序非常有用。</li></ol></blockquote><p>nginx 配置相关内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（1）轮询（Round Robin）模式</span></span><br><span class="line"><span class="attribute">upstream</span> backend-rr &#123;</span><br><span class="line">    <span class="comment">#默认的负载均衡调度模式即为轮询模式，不需要显式地配置</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#（2）加权轮询（Weighted Round Robin）模式</span></span><br><span class="line"><span class="attribute">upstream</span> backend-wrr &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span> weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span> weight=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#（3）IP哈希（IP Hash）模式</span></span><br><span class="line"><span class="attribute">upstream</span> backend-ih &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#（4）最少连接（Least Connections）模式</span></span><br><span class="line"><span class="attribute">upstream</span> backend-lc &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#（5）URL哈希（URL Hash）模式</span></span><br><span class="line"><span class="attribute">upstream</span> backend-uh &#123;</span><br><span class="line">    <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101</span>::<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend-rr;</span><br><span class="line">        <span class="comment"># proxy_pass http://backend-wrr;</span></span><br><span class="line">        <span class="comment"># proxy_pass http://backend-ih;</span></span><br><span class="line">        <span class="comment"># proxy_pass http://backend-lc;</span></span><br><span class="line">        <span class="comment"># proxy_pass http://backend-uh;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-负载均衡健康检查配置"><a class="header-anchor" href="#2-负载均衡健康检查配置">¶</a>2）负载均衡健康检查配置</h4><h5 id="1-简要说明"><a class="header-anchor" href="#1-简要说明">¶</a>（1）简要说明</h5><p>Nginx健康检查的作用：</p><blockquote><p>Nginx 的健康检查功能主要用于监控后端服务器的可用性和状态，以确保请求被正确地转发给可用的服务器。具体作用如下：</p><ol><li>确保服务可用性：通过定期向后端服务器发送健康检查请求，Nginx可以检测到服务器是否在线、响应正常以及服务是否可用。如果某个服务器宕机或无法正常响应请求，Nginx将自动将请求转发给其他可用的服务器，确保服务的持续可用性。</li><li>动态负载均衡：健康检查功能可以让Nginx根据后端服务器的状态自动调整请求的转发策略。当某个服务器出现故障或性能下降时，Nginx可以暂时将请求从故障的服务器转发到其他健康的服务器，实现负载均衡并避免向不可用的服务器发送请求。</li><li>故障自动恢复：健康检查还能够帮助Nginx检测到后端服务器的恢复情况。一旦某个服务器恢复正常，健康检查会将其标记为健康，并重新将请求转发到该服务器上，实现故障自动恢复。</li><li>避免服务雪崩效应：通过定期检查后端服务器的状态，Nginx可以及时发现故障服务器，并将请求转发到其他可用的服务器上。这有助于避免由于故障服务器无法处理请求而导致的服务雪崩效应，提高整体系统的稳定性和可靠性。</li></ol><p>总的来说，Nginx的健康检查功能可以提升后端服务器的可用性、优化负载均衡策略、自动恢复故障服务器，并提高整个系统的可靠性和性能。</p></blockquote><p>Nginx健康检查的类型：</p><blockquote><p>💁‍♂ Nginx 支持两种类型的健康检查：被动健康检查和主动健康检查。</p><ul><li><p>被动健康检查（Passive Health Checks）： 被动健康检查是指Nginx通过监控后端服务器的请求响应来确定服务器的健康状态。当Nginx向后端服务器转发请求时，它会等待一段时间来接收服务器的响应。如果服务器在规定时间内成功响应请求，Nginx将认为服务器是健康的，并继续将请求转发到该服务器。如果服务器在规定时间内无法响应请求（例如返回错误状态码或连接超时），Nginx将认为服务器是不健康的，并停止将请求转发到该服务器，直到下次健康检查重新确定其健康状态。</p></li><li><p>主动健康检查（Active Health Checks）： 主动健康检查是指Nginx定期主动向后端服务器发送健康检查请求来确定服务器的健康状态。Nginx会按照预设的时间间隔发送健康检查请求到后端服务器，并等待服务器的响应。如果服务器成功响应了健康检查请求，Nginx将认为服务器是健康的，并继续将请求转发到该服务器。如果服务器无法响应健康检查请求（例如返回错误状态码或连接超时），Nginx将认为服务器是不健康的，并停止将请求转发到该服务器，直到下次健康检查重新确定其健康状态。主动健康检查相对于被动健康检查可以更快地恢复故障服务器的流量分发，这是因为它可以主动监控和检测后端服务器的健康状态。</p></li></ul><p>💁‍♂ 被动健康检查的主动健康检查的选择：</p><ul><li><p>使用被动健康检查时，Nginx 只能在收到客户端请求时才能检测后端服务器的状态。如果后端服务器出现故障或变得不可用，Nginx 需要等待客户端请求到达并在一定时间内没有收到正确的响应，才会暂时将流量停止发送到该服务器。这意味着在发生故障时，存在一定的延迟时间（通常是几秒钟）才能切换流量到其他可用的服务器上。其适用于对故障恢复速度要求不高的情况。</p></li><li><p>使用主动健康检查时，其允许 Nginx 定期发送健康检查请求到后端服务器。如果服务器无法正常响应或返回错误的响应，Nginx 将立即意识到该服务器的故障，并停止将流量发送到该服务器，而不需要等待客户端请求。这使得故障服务器的恢复速度更快，因为 Nginx 可以更快地检测到故障并将流量转移到其他健康的服务器上。通过主动健康检查，Nginx 可以更及时地发现故障，并且可以更快地将流量从故障服务器切换到其他可用服务器上，从而提高系统的可用性和故障恢复速度。其适用于对故障恢复速度要求比较高的情况。</p></li></ul></blockquote><h5 id="2-被动健康检查配置"><a class="header-anchor" href="#2-被动健康检查配置">¶</a>（2）被动健康检查配置</h5><p>Nginx 默认是支持基础的被动健康检查的（由<code>ngx_http_upstream_module</code>模块支持），使用配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> ops_load &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101:8080</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">10s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">10s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://ops_load;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>max_fails=1 fail_timeout=10s</code> 说明：如果后端服务器在一次健康检查周期内（由Nginx配置中的<code>check interval</code>指定）失败一次或更多，则将其标记为不健康状态。一旦标记为不健康状态，Nginx将暂时将其排除在负载均衡范围之外的时间（由<code>fail_timeout</code>指定），在此期间不会将请求转发给该服务器。过了指定的时间后，Nginx将重新尝试将请求转发给该服务器。</p><ul><li><code>max_fails=1</code>：表示在一次健康检查周期内，允许的最大失败次数。如果在一次健康检查周期内，该服务器的失败次数达到或超过设定的最大失败次数，则该服务器将被标记为不健康状态。</li><li><code>fail_timeout=10s</code>：表示在服务器被标记为不健康状态后，暂时将其排除在负载均衡范围之外的时间。在指定的时间段内，Nginx不会将请求转发给该服务器。在此示例中，如果服务器被标记为不健康状态，将在10秒后重新尝试将请求转发给该服务器。</li></ul></blockquote><h5 id="3-主动健康检查"><a class="header-anchor" href="#3-主动健康检查">¶</a>（3）主动健康检查</h5><p>Nginx 默认不支持主动健康检查，需使用第三方模块来支持，可使用开源的 <a href="https://github.com/yaoweibin/nginx_upstream_check_module" target="_blank" rel="noopener">nginx_upstream_check_module</a> 模块来实现主动健康检查，重新编译安装 nginx 导入导入该模块，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（1）下载nginx_upstream_check_module模块源码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yaoweibin/nginx_upstream_check_module.git /tmp/nginx_upstream_check_module</span><br><span class="line"><span class="comment">#git clone https://ghproxy.com/https://github.com/yaoweibin/nginx_upstream_check_module.git /tmp/nginx_upstream_check_module</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#（2）下载nginx源码包</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#（3）解压nginx源码包</span></span><br><span class="line">tar zxvf nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#（4）进入解压好的nginx源码目录</span></span><br><span class="line"><span class="built_in">cd</span>  nginx-1.20.1</span><br><span class="line"></span><br><span class="line"><span class="comment">#（5）（可选）如果需要使用健康监控页面，则需要使用nginx_upstream_check_module模块的补丁文件给nginx源码打补丁（修改nginx源码）</span></span><br><span class="line">yum install -y patch</span><br><span class="line">patch -p1 &lt; /tmp/nginx_upstream_check_module/check_1.20.1+.patch <span class="comment">#指定特定nginx版本的补丁文件给nginx源码打补丁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#（6）指定nginx_upstream_check_module模块路径生成nginx的编译配置文件MakeFile</span></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/opt/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_sub_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--add-module=/tmp/nginx_upstream_check_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#（7）编译并安装</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><blockquote><p>说明：nginx 各版本编译<code>nginx_upstream_check_module</code>模块后即可正常使用主动健康检查配置，但是要使用该模块的健康监控页面功能（由模块的<code>check_status</code>指令支持），则需要安装模块中补丁支持的特定版本 nginx（支持版本可在模块源码中查看，例如源码中有<code>check_1.20.1+.patch</code>这个补丁文件，则说明其支持 nginx 的<code>1.20.1</code>版本），并使用模块中特定版本的补丁修改 nginx 源码，否则可能会出现访问健康监控页面失败的问题。提示：健康监控页面是否能用不影响主动健康检查功能的使用，故打不打补丁根据需求来决定。</p></blockquote><p>nginx 使用配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> ops_load &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.101:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.60.102:8080</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#以10s为一个周期，每隔10s，nginx会自动向上游服务器发送一次请求，如果超过5s超时且达到3次，则该服务器标记为不可用；</span></span><br><span class="line">    <span class="comment">#如果请求次数有1次以上没有超时，这标记为可用</span></span><br><span class="line">    <span class="attribute">check</span> interval=<span class="number">10000</span> rise=<span class="number">1</span> fall=<span class="number">3</span> timeout=<span class="number">5000</span> type=tcp default_down=<span class="literal">true</span>;</span><br><span class="line">    <span class="attribute">check_http_send</span> <span class="string">"HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n"</span>;</span><br><span class="line">    <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://ops_load;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 健康监控页面</span></span><br><span class="line">    <span class="attribute">location</span> /status &#123;</span><br><span class="line">        check_status;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="comment">#allow 127.0.0.1;</span></span><br><span class="line">        <span class="comment">#deny all;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>nginx_upstream_check_module</code> 模块中相关指令说明:</p><ul><li><code>check</code>：健康检查规则</li></ul><p>语法：<code>check interval=milliseconds [fall=count] [rise=count] [timeout=milliseconds] [default_down=true|false] [type=tcp|http|ssl_hello|mysql|ajp|fastcgi]</code></p><p>如果省略参数，则默认参数为 <code>interval=30000 fall=5 rise=2 timeout=1000 default_down=true type=tcp</code></p><p>相关参数说明：</p><ul><li><p><code>interval</code>：检查请求的间隔时间</p></li><li><p><code>rise</code>：如果请求次数有指定次数以上没有超时，这标记为可用状态</p></li><li><p><code>fall</code>：达到的指定失败次数则标记为不可用状态</p></li><li><p><code>timeout</code>：请求达到指定的超时时间则标记为不可用状态</p></li><li><p><code>type</code>：检查协议类型（tcp、ssl_hello、http、mysql、ajp、fastcgi）</p></li><li><p><code>default_down</code>：设置后端服务器的初始状态（<code>false</code>：可用，默认；<code>true</code>：不可用）</p></li><li><p><code>port</code>：指定后端服务器的检查端口。有可能与原始服务器端口不同。默认端口为 0，表示与原来的后端服务器相同</p></li><li><p><code>check_http_send</code>：发送给后端服务器的请求数据报文</p></li><li><p><code>check_http_expect_alive</code>：判断后端服务器为健康的相应状态码</p></li><li><p><code>check_status</code>：通过 HTTP 方式显示健康检查服务器的状态。</p></li></ul><p>设 Nginx 服务器 IP 地址为：<code>192.168.60.156</code>，则健康监控页面的访问地址：<a href="http://192.168.60.156:8080/status" target="_blank" rel="noopener">http://192.168.60.156:8080/status</a></p><p>可以指定如下 URL 参数指定健康监控页面响应的数据格式</p><ul><li><code>/status?format=html</code></li><li><code>/status?format=csv</code></li><li><code>/status?format=json</code></li></ul><p>健康监控页面效果如下：</p><p><img src="/devops/../images/loading-post.gif" data-original="nginx/image-20230612161929459.png" alt="image-20230612161929459"></p></blockquote><h4 id="3-通过反向代理实现动静分离"><a class="header-anchor" href="#3-通过反向代理实现动静分离">¶</a>3）通过反向代理实现动静分离</h4><p><img src="/devops/../images/loading-post.gif" data-original="nginx/image-20191125010102331.png" alt="image-20191125010102331"></p><blockquote><p>这里的静态资源用图片来表示，而动态资源用 jsp 来表示。</p></blockquote><h5 id="1-使用tomcat配置动态资源"><a class="header-anchor" href="#1-使用tomcat配置动态资源">¶</a>1. 使用tomcat配置动态资源</h5><blockquote><p>说明：</p><ul><li>安装 jdk 并配置环境变量</li><li>安装 tomcat，官方下载解压即用（设安装路径为：<code>/opt/apache-tomcat-8.5.31</code>）</li></ul></blockquote><p>（1）在 tomcat web 根目录里创建一个 jsp 测试文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/apache-tomcat-8.5.31/webapps/ROOT/java_test.jsp</span><br></pre></td></tr></table></figure><p>内容如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> <span class="keyword">import</span>=<span class="string">"java.util.*"</span> pageEncoding=<span class="string">"utf-8"</span>%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;JSP Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        out.println(<span class="string">"&lt;h2&gt;Random number:&lt;/h2&gt;"</span>);</span><br><span class="line">        out.println(rand.nextInt(<span class="number">99</span>)+<span class="number">100</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>（2）运行 tomcat</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /opt/apache-tomcat-8.5.31/bin/startup.sh</span><br></pre></td></tr></table></figure><h5 id="2-使用nginx配置静态资源和反向代理"><a class="header-anchor" href="#2-使用nginx配置静态资源和反向代理">¶</a>2. 使用nginx配置静态资源和反向代理</h5><p>（1）创建一个 nginx 配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/nginx/conf/conf.d/dynamic_static.conf</span><br></pre></td></tr></table></figure><p>配置内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态资源</span></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /opt/nginx/html;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 动态资源</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ .*\.jsp$</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.60.102:8080; <span class="comment"># 反向代理到 Tomcat</span></span><br><span class="line">        <span class="comment">#代理到tomcat等服务器时注意要设置请求参数，如果后端服务器设置有类似防盗链或者根据http请求头中的host字段来进行路由或判断功能的话，如果反向代理层的nginx不重写请求头中的host字段，将会导致请求失败，报400错误。故至少要包含proxy_set_header Host $http_host;为了方便，以下配置了跟多的请求参数。</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="comment"># proxy_redirect default;</span></span><br><span class="line">        <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">        <span class="comment"># proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">        <span class="comment"># proxy_connect_timeout 30;</span></span><br><span class="line">        <span class="comment"># proxy_send_timeout 60;</span></span><br><span class="line">        <span class="comment"># proxy_read_timeout 60;</span></span><br><span class="line">        <span class="comment"># proxy_buffer_size 32k;</span></span><br><span class="line">        <span class="comment"># proxy_buffering on;</span></span><br><span class="line">        <span class="comment"># proxy_buffers 4 128k;</span></span><br><span class="line">        <span class="comment"># proxy_busy_buffers_size 256k;</span></span><br><span class="line">        <span class="comment"># proxy_max_temp_file_size 256k;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（2）上传一张静态资源文件图片（如：<code>logo.jpg</code>）到里 <code>/opt/nginx/html</code> 目录里。</p><p>（3）为了能体现出动静分离的效果，可创建一个同时有静态资源内容又有静态资源内容的 html 测试文件，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/nginx/html/dynamic_static.html</span><br></pre></td></tr></table></figure><p>内容如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>测试nginx动静分离<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.1.4/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">         $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"GET"</span>,</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">"/java_test.jsp"</span>,</span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                        $(<span class="string">"#get_data"</span>).html(data)</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                error: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                        alert(<span class="string">"fail!!,请刷新再试!"</span>);</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">"color: #0688e8;"</span>&gt;</span>测试动静分离<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>静态数据:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/logo.jpg"</span> <span class="attr">height</span>=<span class="string">"200"</span> <span class="attr">width</span>=<span class="string">"200"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>动态数据:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"get_data"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>（4）配置防火墙和重载 nginx 配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#防火墙开放相关监听端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#重载配置</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h5 id="3-访问测试"><a class="header-anchor" href="#3-访问测试">¶</a>3. 访问测试</h5><blockquote><p>设服务器 IP 地址为：<code>198.23.188.200</code>，则测试如下：</p><ul><li><p>访问静态资源：<a href="http://198.23.188.200:8080/logo.jpg" target="_blank" rel="noopener">http://198.23.188.200:8080/logo.jpg</a></p></li><li><p>访问动态资源：<a href="http://198.23.188.200:8080/java_test.jsp" target="_blank" rel="noopener">http://198.23.188.200:8080/java_test.jsp</a></p></li><li><p>访问动静分离页面：<a href="http://198.23.188.200:8080/dynamic_static.html" target="_blank" rel="noopener">http://198.23.188.200:8080/dynamic_static.html</a></p></li></ul></blockquote><h2 id="九-配置ssl证书以使用https"><a class="header-anchor" href="#九-配置ssl证书以使用https">¶</a>九、配置ssl证书以使用https</h2><p>使用 https 就需要配置 ssl 证书。一般地，获取 ssl 证书有两种方式：自签名和购买 CA 颁发的 ssl 证书。自签名的证书可能会被浏览器拦截并提示不受信任，因此建议采用比较可靠的商业颁发机构购买（如 Comodo、Symantec 等）或者免费的 Let’s Encrypt 签发的证书。可以使用 certbot 工具来申请得到免费 Let’ s Encrypt SSL 证书。具体操作可参考<a href="../tools/certbot.html" name="../tools/certbot.md" id="hexo-md-link">《通过certbot工具生成ssl证书》</a>。假设这里已经申请得到了 Let’ s Encrypt SSL 证书，下文将介绍如何在 nginx 中配置 ssl 证书以使用 https 。</p><h3 id="1-创建nginx配置文件"><a class="header-anchor" href="#1-创建nginx配置文件">¶</a>1. 创建nginx配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/nginx/conf/conf.d/https.conf</span><br></pre></td></tr></table></figure><p>配置内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="comment">#ssl_certificate /path/cert.pem;</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /path/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /path/privkey.pem;</span><br><span class="line">    <span class="comment">#ssl_trusted_certificate /path/chain.pem;</span></span><br><span class="line">    <span class="comment">#ssl_trusted_certificate /path/fullchain.pem;</span></span><br><span class="line">    <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># http资源服务</span></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /opt/nginx/html;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 反向代理</span></span><br><span class="line">    <span class="comment"># location ^~ /app &#123;</span></span><br><span class="line">    <span class="comment">#     proxy_pass http://127.0.0.1:8080;</span></span><br><span class="line">    <span class="comment">#     proxy_set_header Host $host:$server_port;</span></span><br><span class="line">    <span class="comment">#     proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    <span class="comment">#     proxy_set_header REMOTE-HOST $remote_addr;</span></span><br><span class="line">    <span class="comment">#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">    <span class="comment">#     client_max_body_size 100m;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>💁‍♂ nginx SSL 证书配置说明：</p><ul><li><p><code>ssl_certificate</code>：SSL证书路径。（可配置为服务端证书或全链证书）</p></li><li><p><code>ssl_certificate_key</code>：私钥文件路径。</p></li><li><p><code>ssl_trusted_certificate</code>：可信任的证书链文件路径。（可配置为中间证书或全链证书）</p></li></ul><p>如果<code>ssl_certificate</code>配置的证书为服务端证书而不包含中间证书，则应该配置 <code>ssl_trusted_certificate</code> 来指定可信任的证书链文件，以便客户端能够正确验证服务端证书的真实性。但由于目前主流CA服务商（包括 Let’s Encrypt ）的根证书和中间证书都已经被大多数客户端（如：主流的浏览器）的证书信任列表所接受，所以服务端配置中即使缺少中间证书和根证书，客户端仍然可以正确地验证服务器证书的真实性，也就是说 <code>ssl_certificate</code> 配置 主流CA签发的 SSL 证书时，即使不是全链证书也能被大多数主流的客户端信任。</p><p>💁‍♂ 关于证书链的说明：</p><ul><li>客户端验证服务器证书的真实性是通过证书链来实现的。如果证书链中最顶层的证书（即CA根证书）在客户端的信任列表里，客户端会从上往下按序验证每层证书的真实性，每一层都使用上一层证书的公钥来验证下一层证书的签名，直到验证到服务器证书为止。如果证书链缺少中间证书，则客户端无法验证该证书链的完整性，也就无法验证服务端证书的真实性。因此，必须包括所有中间证书以及根证书才能构建完整的证书链。只有在证书链完整且验证成功的情况下，客户端才能信任服务器证书并与其建立安全连接。</li><li>客户端的信任列表一般包括有根证书、中间证书以及其他可信任的证书等。</li></ul></blockquote><h3 id="2-配置防火墙和重载nginx配置"><a class="header-anchor" href="#2-配置防火墙和重载nginx配置">¶</a>2. 配置防火墙和重载nginx配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#防火墙开放相关监听端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=443/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#重载配置（重新加载 nginx 配置以使得 SSL 证书生效）</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h3 id="3-测试https访问"><a class="header-anchor" href="#3-测试https访问">¶</a>3. 测试https访问</h3><p>创建一个待测试的html静态资源文件，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;h1&gt;Hi, Nginx !&lt;/h1&gt;"</span> &gt;&gt; /opt/nginx/html/<span class="built_in">test</span>-https.html</span><br></pre></td></tr></table></figure><blockquote><p>访问地址为：<a href="https://example.com/test-https.html" target="_blank" rel="noopener">https://example.com/test-https.html</a></p></blockquote><h2 id="十-配置nginx进程和其执行用户"><a class="header-anchor" href="#十-配置nginx进程和其执行用户">¶</a>十、配置nginx进程和其执行用户</h2><h3 id="1-nginx进程"><a class="header-anchor" href="#1-nginx进程">¶</a>1. nginx进程</h3><p>在 Nginx 的主进程启动后，会创建多个子进程来处理客户端请求和其他任务。这些子进程通常由 Nginx 主进程负责管理、调度和监控。</p><blockquote><p>Nginx 子进程通常分为以下几种类型：</p><ul><li><code>master process</code>（主进程）：Nginx 的主进程，负责管理所有子进程，接收和处理来自命令行的信号，并启动整个 Nginx 服务。</li><li><code>worker process</code>（工作进程）：Nginx 的工作进程，负责处理客户端请求和其他任务，每个工作进程都是一个独立的进程，可以同时处理多个请求。</li><li><code>cache loader process</code>（缓存加载进程）：用于加载和预热缓存数据的进程，只有在开启缓存功能时才会启动。</li><li><code>cache manager process</code>（缓存管理进程）：用于管理缓存数据和处理缓存清理的进程，只有在开启缓存功能时才会启动。</li></ul></blockquote><p>通常配置工作进程以满足业务需求。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定启动的工作进程数量（默认值为：auto，表示以CPU核心数决定工作进程数量）</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">2</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment">#设置每个工作进程与客户端之间的最大连接数（默认值为：512）</span></span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下为其他无关配置...</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">   <span class="comment"># 其他配置项...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-nginx进程执行用户"><a class="header-anchor" href="#2-nginx进程执行用户">¶</a>2. nginx进程执行用户</h3><p>默认情况下，Nginx 启动后会创建一个主进程和多个工作进程，其中主进程为运行nginx服务的linux用户（通常是 root 用户），而每个工作进程都是以指定用户身份来执行的，默认情况下是以 <code>nobody</code> 用户身份运行。可以通过修改配置文件中的 <code>user</code> 指令来改变工作进程的执行用户。具体操作如下：</p><p>(1) 创建nginx工作进程的执行用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建nginx用户和同名用户组，不自动创建用户主目录，禁止该用户登录系统</span></span><br><span class="line">useradd -U -M -s /usr/sbin/nologin nginx</span><br></pre></td></tr></table></figure><p>(2) 修改 nginx 主配置文件<code>nginx.conf</code>，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>修改如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改user指令即可</span></span><br><span class="line"><span class="attribute">user</span>  nginx; <span class="comment">#nginx工作进程的执行用户</span></span><br><span class="line"><span class="comment">#user  nginx nginx; #指定用户和用户组，如果没有指定用户组，则使用默认用户组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#以下为其他无关配置...</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 其他配置项...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：修改 nginx 用户后需要注意也要同时修改一些 nginx 相关的临时文件权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R nginx:nginx /opt/nginx/proxy_temp</span><br><span class="line">chown -R nginx:nginx /opt/nginx/logs</span><br></pre></td></tr></table></figure><p>（4）重载nginx配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重载配置</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="十一-配置文件模块化"><a class="header-anchor" href="#十一-配置文件模块化">¶</a>十一、配置文件模块化</h2><h3 id="简要概述"><a class="header-anchor" href="#简要概述">¶</a>简要概述</h3><p>在 Nginx 配置文件中可以通过使用 <code>include</code> 指令来实现模块化。从而让配置文件具有可复用性和更易维护性。</p><p>具体表现为：允许用户将配置文件拆分为更小的配置文件，使配置更加清晰和可维护。然后通过 <code>include</code> 指令来包含这些被拆分的配置文件到某个配置文件中。</p><h3 id="include-指令的语法"><a class="header-anchor" href="#include-指令的语法">¶</a>include 指令的语法</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">include</span> file | mask;</span><br></pre></td></tr></table></figure><blockquote><p>其中：</p><ul><li><code>file</code> 是要包含的单个文件的路径，可以是绝对路径或相对于 Nginx 配置文件的路径。</li><li><code>mask</code> 是一个通配符表达式，用于匹配多个文件。可以使用通配符字符 <code>*</code> 和 <code>?</code>。</li></ul></blockquote><h3 id="include-指令使用示例"><a class="header-anchor" href="#include-指令使用示例">¶</a>include 指令使用示例</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#包含单个文件</span></span><br><span class="line"><span class="attribute">include</span> /path/to/file.conf;</span><br><span class="line"></span><br><span class="line"><span class="comment">#包含多个文件，使用通配符匹配</span></span><br><span class="line"><span class="attribute">include</span> /path/to/conf.d/<span class="regexp">*.conf</span>;</span><br></pre></td></tr></table></figure><blockquote><p>请注意，<code>include</code> 指令可以出现在任何适当的位置，以包含其他配置文件的内容。当 Nginx 读取配置文件时，它会按照指令的顺序逐行解析，并将包含的文件内容合并到最终的配置中。</p></blockquote><h2 id="十一-配置日志"><a class="header-anchor" href="#十一-配置日志">¶</a>十一、配置日志</h2><p>Nginx 默认有两种日志文件的记录，即 <code>error_log</code>（错误日志）和 <code>access_log</code>（访问日志）。用户可以分别对这两种日志文件进行相关自定义配置。</p><h3 id="error-log-错误日志配置"><a class="header-anchor" href="#error-log-错误日志配置">¶</a><code>error_log</code> 错误日志配置</h3><p><code>error_log</code> 命令用于记录 Nginx 的错误信息，可以配置 <code>off</code>停止日志记录，或者配置日志路径和错误级别进行日志记录，默认支持的错误级别如下：</p><blockquote><ul><li><code>error</code>：记录错误消息。</li><li><code>warn</code>：记录警告消息和错误消息。</li><li><code>notice</code>：记录普通但重要的信息。</li><li><code>info</code>：记录更详细的信息，通常用于调试。</li><li><code>debug</code>：记录详细的调试信息，通常用于详尽的故障排除。</li></ul></blockquote><p>使用格式如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_log</span>  logs/error.log  <span class="literal">error</span>;</span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"><span class="comment">#error_log off; #停止错误日志记录</span></span><br></pre></td></tr></table></figure><h3 id="access-log-访问日志配置"><a class="header-anchor" href="#access-log-访问日志配置">¶</a><code>access_log</code> 访问日志配置</h3><p><code>access_log</code> 命令用于记录客户端请求的访问日志，可以配置 <code>off</code>停止日志记录，或者配置日志路径和日志格式进行日志记录，默认支持：<code>combined</code>（默认，即都不配置日志的情况）、<code>main</code>（安装后通常自动使用的格式） 这些日志格式，当然用户可以自定义日志格式，如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> custom  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                   <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                   <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"><span class="comment">#log_format custom '请求时间=$time_iso8601 | 请求IP=$remote_addr | 请求URL=$request | 请求数据类型=$http_content_type | 请求代理=$http_user_agent | 请求头大小=$body_bytes_sent | 来源URL地址=$http_referer | 客户端的真实IP=$http_x_forwarded_for | 响应状态码=$status | 响应数据类型=$sent_http_content_type | 响应时间=$upstream_response_time';</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">access_log</span>  logs/access.log  custom;</span><br><span class="line"></span><br><span class="line"><span class="comment">#access_log off; #停止访问日志记录</span></span><br></pre></td></tr></table></figure><h3 id="按照日期格式配置日志文件名称"><a class="header-anchor" href="#按照日期格式配置日志文件名称">¶</a>按照日期格式配置日志文件名称</h3><p>随着 nginx 长时间运行，日志文件也会变得越来越多，甚至几个月就达到了几个 GB 的大小，这会导致在排查日志时会由于内容太多而不好定位。为了解决这个问题，可以配置 nginx 记录日志时按照日期记录到不同的文件里，从而实现日志切割的效果。如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> custom  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                   <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                   <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"><span class="comment">#log_format custom '请求时间=$time_iso8601 | 请求IP=$remote_addr | 请求URL=$request | 请求数据类型=$http_content_type | 请求代理=$http_user_agent | 请求头大小=$body_bytes_sent | 来源URL地址=$http_referer | 客户端的真实IP=$http_x_forwarded_for | 响应状态码=$status | 响应数据类型=$sent_http_content_type | 响应时间=$upstream_response_time';</span></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$time_iso8601</span> <span class="variable">$logdate</span> &#123;</span><br><span class="line">    '~^(?&lt;year&gt;\d&#123;4&#125;)-(?&lt;month&gt;\d&#123;2&#125;)-(?&lt;day&gt;\d&#123;2&#125;)' $year-$month-$day;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">access_log</span> logs/access-<span class="variable">$logdate</span>.log custom;</span><br></pre></td></tr></table></figure><p>设 logs 目录路径为：<code>/opt/nginx/logs</code>，则需要给该目录赋予 worker 进程的用户权限和操作权限。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown nginx:nginx /opt/nginx/logs</span><br><span class="line">chmod 755 /opt/nginx/logs</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重载配置</span></span><br><span class="line">/opt/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure></div><div><div><br><br><div style="text-align:center;color:#ccc;font-size:14px">----------- 本文结束 -----------</div><br><br><br><br></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>如果你觉得我的文章对你有帮助，你可以打赏我哦~</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="../images/loading-post.gif" data-original="/images/wechatpay.png" alt="Qcmoke 微信支付"><p>微信支付</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/nginx/" rel="tag"><i class="fa fa-tag"></i> nginx</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/devops/redis.html" rel="prev" title="redis学习笔记"><i class="fa fa-chevron-left"></i> redis学习笔记</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/javaee/springboot.html" rel="next" title="Spring Boot 学习笔记">Spring Boot 学习笔记 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div class="tablink-li"><button class="tablink" onclick='openPage("tabs-gitalk",this)' id="defaultOpen">Gitalk</button> <button class="tablink" onclick='openPage("tabs-valine",this)'>Valine</button></div><div class="tabcontent-li"><div id="tabs-gitalk" class="tabcontent"><div id="gitalk-container"></div></div><div id="tabs-valine" class="tabcontent"><div id="comments-valine"></div></div></div></div><script>function openPage(e,t){for(var n=document.getElementsByClassName("tabcontent"),l=0;l<n.length;l++)n[l].style.display="none";for(tablinks=document.getElementsByClassName("tablink"),l=0;l<tablinks.length;l++)tablinks[l].classList.remove("currentTabcontent");document.getElementById(e).style.display="block",t.classList.add("currentTabcontent")}document.getElementById("defaultOpen").click()</script></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" src="../images/loading-post.gif" data-original="/images/logo.jpg" alt="Qcmoke"></a><p class="site-author-name" itemprop="name">Qcmoke</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">83</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">91</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:qcmoke@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://github.com/qcmoke" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/5469824288" target="_blank" title="weibo"><i class="fa fa-fw fa-weibo"></i>weibo</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li class="recent_posts_li"><a href="/windows/clean_c_drive.html" title="Windows系统C盘清理" target="_blank">Windows系统C盘清理</a></li><li class="recent_posts_li"><a href="/devops/lvs.html" title="lvs学习笔记" target="_blank">lvs学习笔记</a></li><li class="recent_posts_li"><a href="/devops/mysql_ha.html" title="Keepalived+MySQL实现高可用" target="_blank">Keepalived+MySQL实现高可用</a></li><li class="recent_posts_li"><a href="/devops/keepalived.html" title="keepalived学习笔记" target="_blank">keepalived学习笔记</a></li><li class="recent_posts_li"><a href="/tools/pyenv.html" title="python版本管理工具pyenv" target="_blank">python版本管理工具pyenv</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-简介"><span class="nav-text">一、简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-在线包管理器安装nginx"><span class="nav-text">二、在线包管理器安装nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-apt安装nginx"><span class="nav-text">1. apt安装nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-安装nginx"><span class="nav-text">（1）安装nginx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-卸载nginx"><span class="nav-text">（3）卸载nginx</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-yum安装nginx"><span class="nav-text">2. yum安装nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-设置nginx官方yum源-可选"><span class="nav-text">（1）设置nginx官方yum源（可选）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-安装nginx"><span class="nav-text">（2）安装nginx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-查看nginx安装信息"><span class="nav-text">（3）查看nginx安装信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-卸载nginx"><span class="nav-text">（4）卸载nginx</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-在线包管理器安装nginx路径"><span class="nav-text">3. 在线包管理器安装nginx路径</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-源码编译安装nginx"><span class="nav-text">二、源码编译安装nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-nginx常用命令"><span class="nav-text">三、nginx常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五-nginx内置变量"><span class="nav-text">五、nginx内置变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六-自定义nginx配置文件"><span class="nav-text">六、自定义nginx配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七-配置http服务"><span class="nav-text">七、配置http服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#八-配置反向代理"><span class="nav-text">八、配置反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-反向代理常用指令"><span class="nav-text">1. 反向代理常用指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-简单的反向代理配置"><span class="nav-text">2. 简单的反向代理配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-反向代理相关配置"><span class="nav-text">1）反向代理相关配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-反向代理测试示例"><span class="nav-text">2）反向代理测试示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-高级的反向代理配置"><span class="nav-text">3. 高级的反向代理配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-负载均衡调度模式配置"><span class="nav-text">1）负载均衡调度模式配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-负载均衡健康检查配置"><span class="nav-text">2）负载均衡健康检查配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-简要说明"><span class="nav-text">（1）简要说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-被动健康检查配置"><span class="nav-text">（2）被动健康检查配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-主动健康检查"><span class="nav-text">（3）主动健康检查</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-通过反向代理实现动静分离"><span class="nav-text">3）通过反向代理实现动静分离</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-使用tomcat配置动态资源"><span class="nav-text">1. 使用tomcat配置动态资源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-使用nginx配置静态资源和反向代理"><span class="nav-text">2. 使用nginx配置静态资源和反向代理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-访问测试"><span class="nav-text">3. 访问测试</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#九-配置ssl证书以使用https"><span class="nav-text">九、配置ssl证书以使用https</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-创建nginx配置文件"><span class="nav-text">1. 创建nginx配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-配置防火墙和重载nginx配置"><span class="nav-text">2. 配置防火墙和重载nginx配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-测试https访问"><span class="nav-text">3. 测试https访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十-配置nginx进程和其执行用户"><span class="nav-text">十、配置nginx进程和其执行用户</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-nginx进程"><span class="nav-text">1. nginx进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-nginx进程执行用户"><span class="nav-text">2. nginx进程执行用户</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十一-配置文件模块化"><span class="nav-text">十一、配置文件模块化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简要概述"><span class="nav-text">简要概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include-指令的语法"><span class="nav-text">include 指令的语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include-指令使用示例"><span class="nav-text">include 指令使用示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十一-配置日志"><span class="nav-text">十一、配置日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#error-log-错误日志配置"><span class="nav-text">error_log 错误日志配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#access-log-访问日志配置"><span class="nav-text">access_log 访问日志配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#按照日期格式配置日志文件名称"><span class="nav-text">按照日期格式配置日志文件名称</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Qcmoke</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv">本站访客数 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人次 </span><span class="site-pv">本站总访问量 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div><a href="https://beian.miit.gov.cn/" target="_blank">黔ICP备20002951号-1</a></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><i id="darkmode" class="fa fa-lightbulb-o" aria-hidden="true"></i><script>var body=$("body"),darkmode=$("#darkmode");!matchMedia("(prefers-color-scheme: dark)").matches&&"1"!==localStorage.getItem("darkmode")||"1"===localStorage.getItem("noDark")||body.addClass("dark"),body.hasClass("dark")?darkmode.removeClass("fa-moon-o").addClass("fa-lightbulb-o"):darkmode.removeClass("fa-lightbulb-o").addClass("fa-moon-o"),darkmode.click(function(){body.hasClass("dark")?(darkmode.removeClass("fa-lightbulb-o").addClass("fa-moon-o"),body.removeClass("dark"),localStorage.setItem("darkmode","0"),localStorage.setItem("noDark","1")):(darkmode.removeClass("fa-moon-o").addClass("fa-lightbulb-o"),body.addClass("dark"),localStorage.setItem("darkmode","1"),localStorage.setItem("noDark","0"))})</script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/clipboard.min.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/highlight-wrap.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script src="/js/src/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">for(var emoticonList=[],i=1;i<=164;i++)emoticonList.push("aru ("+i+").png");new Valine({lang:"zh-cn",admin_email:"qcmoke@gmail.com",el:"#comments-valine",appId:"6LNbUERxbG0OAnWfmJSbmXiW-MdYXbMMI",appKey:"d2FLy9fmXOTiM8TrokuIuDWx",placeholder:"留下你的小爪印吧~",serverURLs:"https://leancloud.qcmoke.cn"})</script><script>var checkExist;window.location.hash&&(checkExist=setInterval(function(){$(window.location.hash).length&&($("html, body").animate({scrollTop:$(window.location.hash).offset().top-90},1e3),clearInterval(checkExist))},100))</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script type="text/javascript">const gitalk=new Gitalk({clientID:"d933e443cdfe503ce05a",clientSecret:"149d163f4b10cedf7a68993289da9c0f0836bd34",repo:"mygitalk",owner:"qcmoke",admin:"qcmoke".split(","),id:location.pathname,distractionFreeMode:"true",createIssueManually:"true"});gitalk.render("gitalk-container")</script><script type="text/javascript">var isfetched=!1,isXml=!0,search_path="search.xml",path=(0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1),"/"+search_path),onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,s,a){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");function e(){var e,m=n.value.trim().toLowerCase(),x=m.split(/[\s\-]+/),w=(1<x.length&&x.push(m),[]);0<m.length&&o.forEach(function(t){var e=!1,o=0,h=0,n=t.title.trim(),r=n.toLowerCase(),s=t.content.trim().replace(/<[^>]+>/g,""),a=s.toLowerCase(),i=decodeURIComponent(t.url),c=[],l=[];if(""!=n&&(x.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r,s=0,a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(r=e.indexOf(t,s));)a.push({position:r,word:t}),s=r+n;return a}c=c.concat(e(t,r,!1)),l=l.concat(e(t,a,!1))}),0<c.length||0<l.length)&&(e=!0,o=c.length+l.length),e){function p(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===m&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}[c,l].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});for(var t=[],u=(0!=c.length&&t.push(p(0,0,n.length,c)),[]);0!=l.length;){var f=l[l.length-1],d=f.position,f=f.word,g=d-20,v=d+80;g<0&&(g=0),(v=v<d+f.length?d+f.length:v)>s.length&&(v=s.length),u.push(p(0,g,v,l))}u.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});e=parseInt("1");function $(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}0<=e&&(u=u.slice(0,e));var C="";C+=0!=t.length?"<li><a href='"+i+"' class='search-result-title'>"+$(n,t[0])+"</a>":"<li><a href='"+i+"' class='search-result-title'>"+n+"</a>",u.forEach(function(t){C+="<a href='"+i+'\'><p class="search-result">'+$(s,t)+"...</p></a>"}),C+="</li>",w.push({item:C,searchTextCount:h,hitCount:o,id:w.length})}}),1===x.length&&""===x[0]?r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>':0===w.length?r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>':(w.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id}),e='<ul class="search-result-list">',w.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e)}var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(s),r=document.getElementById(a);n.addEventListener("input",e),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script>function addCount(n){var t=$(".leancloud_visitors"),o=t.attr("id").trim(),i=t.attr("data-flag-title").trim();n("get","/classes/Counter",{where:JSON.stringify({url:o})}).done(function({results:t}){var e;0<t.length?(e=t[0],n("put","/classes/Counter/"+e.objectId,JSON.stringify({time:{__op:"Increment",amount:1}})).done(function(){$(document.getElementById(o)).find(".leancloud-visitors-count").text(e.time+1)}).fail(function({responseJSON:t}){console.log("Failed to save Visitor num, with error message: "+t.error)})):n("post","/classes/Counter",JSON.stringify({title:i,url:o,time:1})).done(function(){$(document.getElementById(o)).find(".leancloud-visitors-count").text(1)}).fail(function(){console.log("Failed to create")})}).fail(function({responseJSON:t}){console.log("LeanCloud Counter Error: "+t.code+" "+t.error)})}$(function(){$.get("https://app-router.leancloud.cn/2/route?appId=6LNbUERxbG0OAnWfmJSbmXiW-MdYXbMMI").done(function({}){/http:\/\/(localhost|127.0.0.1|0.0.0.0)/.test(document.URL)||addCount(function(t,e,n){return $.ajax({method:t,url:"https://leancloud.qcmoke.cn/1.1"+e,headers:{"X-LC-Id":"6LNbUERxbG0OAnWfmJSbmXiW-MdYXbMMI","X-LC-Key":"d2FLy9fmXOTiM8TrokuIuDWx","Content-Type":"application/json"},data:n})})})})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"default",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions)</script><script type="text/javascript">(wpac_init=window.wpac_init||[]).push({widget:"Rating",id:23769,el:"wpac-rating",color:"fc6423"}),function(){var e,t;"WIDGETPACK_LOADED"in window||(WIDGETPACK_LOADED=!0,(e=document.createElement("script")).type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js",(t=document.getElementsByTagName("script")[0]).parentNode.insertBefore(e,t.nextSibling))}()</script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).top&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"left","width":80,"height":130},"mobile":{"show":false},"log":false});</script></body></html>